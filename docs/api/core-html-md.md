Title: 

URL Source: https://docs.fastht.ml/api/core.html.md

Markdown Content:
\# Core


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

This is the source code to fasthtml. You won’t need to read this unless
you want to understand how things are built behind the scenes, or need
full details of a particular API. The notebook is converted to the
Python module
\[fasthtml/core.py\](https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py)
using \[nbdev\](https://nbdev.fast.ai/).

## Imports and utils

\`\`\` python
import time

from IPython import display
from enum import Enum
from pprint import pprint

from fastcore.test import \*
from starlette.testclient import TestClient
from starlette.requests import Headers
from starlette.datastructures import UploadFile
\`\`\`

We write source code \*first\*, and then tests come \*after\*. The tests
serve as both a means to confirm that the code works and also serves as
working examples. The first declared function,
\[\`date\`\](https://AnswerDotAI.github.io/fasthtml/api/core.html#date), is
an example of this pattern.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L40"
target="\_blank" style="float:right; font-size:smaller">source</a>

### date

>      date (s:str)

\*Convert \`s\` to a datetime\*

\`\`\` python
date('2pm')
\`\`\`

    datetime.datetime(2024, 8, 25, 14, 0)

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L45"
target="\_blank" style="float:right; font-size:smaller">source</a>

### snake2hyphens

>      snake2hyphens (s:str)

\*Convert \`s\` from snake case to hyphenated and capitalised\*

\`\`\` python
snake2hyphens("snake\_case")
\`\`\`

    'Snake-Case'

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L62"
target="\_blank" style="float:right; font-size:smaller">source</a>

### HtmxHeaders

>      HtmxHeaders (boosted:str|None=None, current\_url:str|None=None,
>                   history\_restore\_request:str|None=None, prompt:str|None=None,
>                   request:str|None=None, target:str|None=None,
>                   trigger\_name:str|None=None, trigger:str|None=None)

\`\`\` python
def test\_request(url: str='/', headers: dict={}, method: str='get') -> Request:
    scope = {
        'type': 'http',
        'method': method,
        'path': url,
        'headers': Headers(headers).raw,
        'query\_string': b'',
        'scheme': 'http',
        'client': ('127.0.0.1', 8000),
        'server': ('127.0.0.1', 8000),
    }
    receive = lambda: {"body": b"", "more\_body": False}
    return Request(scope, receive)
\`\`\`

\`\`\` python
h = test\_request(headers=Headers({'HX-Request':'1'}))
\_get\_htmx(h.headers)
\`\`\`

    HtmxHeaders(boosted=None, current\_url=None, history\_restore\_request=None, prompt=None, request='1', target=None, trigger\_name=None, trigger=None)

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L72"
target="\_blank" style="float:right; font-size:smaller">source</a>

### str2int

>      str2int (s)

\*Convert \`s\` to an \`int\`\*

\`\`\` python
str2int('1'),str2int('none')
\`\`\`

    (1, 0)

## Request and response

\`\`\` python
test\_eq(\_fix\_anno(Union\[str,None\])('a'), 'a')
test\_eq(\_fix\_anno(float)(0.9), 0.9)
test\_eq(\_fix\_anno(int)('1'), 1)
test\_eq(\_fix\_anno(int)(\['1','2'\]), 2)
test\_eq(\_fix\_anno(list\[int\])(\['1','2'\]), \[1,2\])
test\_eq(\_fix\_anno(list\[int\])('1'), \[1\])
\`\`\`

\`\`\` python
d = dict(k=int, l=List\[int\])
test\_eq(\_form\_arg('k', "1", d), 1)
test\_eq(\_form\_arg('l', "1", d), \[1\])
test\_eq(\_form\_arg('l', \["1","2"\], d), \[1,2\])
\`\`\`

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L108"
target="\_blank" style="float:right; font-size:smaller">source</a>

### HttpHeader

>      HttpHeader (k:str, v:str)

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L126"
target="\_blank" style="float:right; font-size:smaller">source</a>

### form2dict

>      form2dict (form:starlette.datastructures.FormData)

\*Convert starlette form data to a dict\*

\`\`\` python
d = \[('a',1),('a',2),('b',0)\]
fd = FormData(d)
res = form2dict(fd)
test\_eq(res\['a'\], \[1,2\])
test\_eq(res\['b'\], 0)
\`\`\`

\`\`\` python
async def f(req):
    def \_f(p:HttpHeader): ...
    p = first(\_sig(\_f).parameters.values())
    result = await \_from\_body(req, p)
    return JSONResponse(result.\_\_dict\_\_)

app = Starlette(routes=\[Route('/', f, methods=\['POST'\])\])
client = TestClient(app)

d = dict(k='value1',v=\['value2','value3'\])
response = client.post('/', data=d)
print(response.json())
\`\`\`

    {'k': 'value1', 'v': 'value3'}

\`\`\` python
def g(req, this:Starlette, a:str, b:HttpHeader): ...

async def f(req):
    a = await \_wrap\_req(req, \_sig(g).parameters)
    return Response(str(a))

app = Starlette(routes=\[Route('/', f, methods=\['POST'\])\])
client = TestClient(app)

response = client.post('/?a=1', data=d)
print(response.text)
\`\`\`

    \[<starlette.requests.Request object>, <starlette.applications.Starlette object>, '1', HttpHeader(k='value1', v='value3')\]

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L184"
target="\_blank" style="float:right; font-size:smaller">source</a>

### flat\_xt

>      flat\_xt (lst)

\*Flatten lists\*

\`\`\` python
x = ft('a',1)
test\_eq(flat\_xt(\[x, x, \[x,x\]\]), \[x\]\*4)
test\_eq(flat\_xt(x), \[x\])
\`\`\`

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L194"
target="\_blank" style="float:right; font-size:smaller">source</a>

### Beforeware

>      Beforeware (f, skip=None)

\*Initialize self. See help(type(self)) for accurate signature.\*

## Websockets

\`\`\` python
def on\_receive(self, msg:str): return f"Message text was: {msg}"
c = \_ws\_endp(on\_receive)
app = Starlette(routes=\[WebSocketRoute('/', \_ws\_endp(on\_receive))\])

cli = TestClient(app)
with cli.websocket\_connect('/') as ws:
    ws.send\_text('{"msg":"Hi!"}')
    data = ws.receive\_text()
    assert data == 'Message text was: Hi!'
\`\`\`

## Routing and application

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L254"
target="\_blank" style="float:right; font-size:smaller">source</a>

### WS\_RouteX

>      WS\_RouteX (path:str, recv, conn:<built-infunctioncallable>=None,
>                 disconn:<built-infunctioncallable>=None, name=None,
>                 middleware=None, hdrs=None, before=None)

\*Initialize self. See help(type(self)) for accurate signature.\*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L260"
target="\_blank" style="float:right; font-size:smaller">source</a>

### uri

>      uri (\_arg, \*\*kwargs)

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L264"
target="\_blank" style="float:right; font-size:smaller">source</a>

### decode\_uri

>      decode\_uri (s)

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L275"
target="\_blank" style="float:right; font-size:smaller">source</a>

### StringConvertor.to\_string

>      StringConvertor.to\_string (value:str)

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L283"
target="\_blank" style="float:right; font-size:smaller">source</a>

### HTTPConnection.url\_path\_for

>      HTTPConnection.url\_path\_for (name:str, \*\*path\_params)

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L318"
target="\_blank" style="float:right; font-size:smaller">source</a>

### flat\_tuple

>      flat\_tuple (o)

\*Flatten lists\*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L362"
target="\_blank" style="float:right; font-size:smaller">source</a>

### RouteX

>      RouteX (path:str, endpoint, methods=None, name=None,
>              include\_in\_schema=True, middleware=None, hdrs=None, ftrs=None,
>              before=None, after=None, htmlkw=None, \*\*bodykw)

\*Initialize self. See help(type(self)) for accurate signature.\*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L388"
target="\_blank" style="float:right; font-size:smaller">source</a>

### RouterX

>      RouterX (routes=None, redirect\_slashes=True, default=None,
>               on\_startup=None, on\_shutdown=None, lifespan=None,
>               middleware=None, hdrs=None, ftrs=None, before=None, after=None,
>               htmlkw=None, \*\*bodykw)

\*Initialize self. See help(type(self)) for accurate signature.\*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L415"
target="\_blank" style="float:right; font-size:smaller">source</a>

### get\_key

>      get\_key (key=None, fname='.sesskey')

\`\`\` python
get\_key()
\`\`\`

    '480ec94e-c759-4105-afd8-3a64af020118'

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L444"
target="\_blank" style="float:right; font-size:smaller">source</a>

### FastHTML

>      FastHTML (debug=False, routes=None, middleware=None,
>                exception\_handlers=None, on\_startup=None, on\_shutdown=None,
>                lifespan=None, hdrs=None, ftrs=None, before=None, after=None,
>                ws\_hdr=False, ct\_hdr=False, surreal=True, htmx=True,
>                default\_hdrs=True, sess\_cls=<class
>                'starlette.middleware.sessions.SessionMiddleware'>,
>                secret\_key=None, session\_cookie='session\_', max\_age=31536000,
>                sess\_path='/', same\_site='lax', sess\_https\_only=False,
>                sess\_domain=None, key\_fname='.sesskey', htmlkw=None, \*\*bodykw)

\\\*Creates an application instance.

\*\*Parameters:\*\*

- \*\*debug\*\* - Boolean indicating if debug tracebacks should be returned
  on errors.
- \*\*routes\*\* - A list of routes to serve incoming HTTP and WebSocket
  requests.
- \*\*middleware\*\* - A list of middleware to run for every request. A
  starlette application will always automatically include two middleware
  classes. \`ServerErrorMiddleware\` is added as the very outermost
  middleware, to handle any uncaught errors occurring anywhere in the
  entire stack. \`ExceptionMiddleware\` is added as the very innermost
  middleware, to deal with handled exception cases occurring in the
  routing or endpoints.
- \*\*exception\_handlers\*\* - A mapping of either integer status codes, or
  exception class types onto callables which handle the exceptions.
  Exception handler callables should be of the form
  \`handler(request, exc) -> response\` and may be either standard
  functions, or async functions.
- \*\*on\_startup\*\* - A list of callables to run on application startup.
  Startup handler callables do not take any arguments, and may be either
  standard functions, or async functions.
- \*\*on\_shutdown\*\* - A list of callables to run on application shutdown.
  Shutdown handler callables do not take any arguments, and may be
  either standard functions, or async functions.
- \*\*lifespan\*\* - A lifespan context function, which can be used to
  perform startup and shutdown tasks. This is a newer style that
  replaces the \`on\_startup\` and \`on\_shutdown\` handlers. Use one or the
  other, not both.\\\*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L487"
target="\_blank" style="float:right; font-size:smaller">source</a>

### FastHTML.route

>      FastHTML.route (path:str=None, methods=None, name=None,
>                      include\_in\_schema=True)

\*Add a route at \`path\`\*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L507"
target="\_blank" style="float:right; font-size:smaller">source</a>

### serve

>      serve (appname=None, app='app', host='0.0.0.0', port=None, reload=True,
>             reload\_includes:list\[str\]|str|None=None,
>             reload\_excludes:list\[str\]|str|None=None)

\*Run the app in an async server, with live reload set as the default.\*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>appname</td>
<td>NoneType</td>
<td>None</td>
<td>Name of the module</td>
</tr>
<tr class="even">
<td>app</td>
<td>str</td>
<td>app</td>
<td>App instance to be served</td>
</tr>
<tr class="odd">
<td>host</td>
<td>str</td>
<td>0.0.0.0</td>
<td>If host is 0.0.0.0 will convert to localhost</td>
</tr>
<tr class="even">
<td>port</td>
<td>NoneType</td>
<td>None</td>
<td>If port is None it will default to 5001 or the PORT environment
variable</td>
</tr>
<tr class="odd">
<td>reload</td>
<td>bool</td>
<td>True</td>
<td>Default is to reload the app upon code changes</td>
</tr>
<tr class="even">
<td>reload\_includes</td>
<td>list\[str\] | str | None</td>
<td>None</td>
<td>Additional files to watch for changes</td>
</tr>
<tr class="odd">
<td>reload\_excludes</td>
<td>list\[str\] | str | None</td>
<td>None</td>
<td>Files to ignore for changes</td>
</tr>
</tbody>
</table>

## Extras

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L529"
target="\_blank" style="float:right; font-size:smaller">source</a>

### cookie

>      cookie (key:str, value='', max\_age=None, expires=None, path='/',
>              domain=None, secure=False, httponly=False, samesite='lax')

\*Create a ‘set-cookie’
\[\`HttpHeader\`\](https://AnswerDotAI.github.io/fasthtml/api/core.html#httpheader)\*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L547"
target="\_blank" style="float:right; font-size:smaller">source</a>

### reg\_re\_param

>      reg\_re\_param (m, s)

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/fasthtml/blob/main/fasthtml/core.py#L557"
target="\_blank" style="float:right; font-size:smaller">source</a>

### MiddlewareBase

>      MiddlewareBase ()

\*Initialize self. See help(type(self)) for accurate signature.\*

## Tests

\`\`\` python
def get\_cli(app): return app,TestClient(app),app.route
\`\`\`

\`\`\` python
app,cli,rt = get\_cli(FastHTML(secret\_key='soopersecret'))
\`\`\`

\`\`\` python
@rt("/hi")
def get(): return 'Hi there'

r = cli.get('/hi')
r.text
\`\`\`

    'Hi there'

\`\`\` python
@rt("/hi")
def post(): return 'Postal'

cli.post('/hi').text
\`\`\`

    'Postal'

\`\`\` python
@app.get("/hostie")
def show\_host(req): return req.headers\['host'\]

cli.get('/hostie').text
\`\`\`

    'testserver'

\`\`\` python
@rt
def yoyo(): return 'a yoyo'

cli.post('/yoyo').text
\`\`\`

    'a yoyo'

\`\`\` python
@app.get
def autopost(): return Html(Div('Text.', hx\_post=yoyo()))
print(cli.get('/autopost').text)
\`\`\`

    <!doctype html>

    <html><div hx-post="a yoyo">Text.</div>
    </html>

\`\`\` python
@app.get
def autopost2(): return Html(Body(Div('Text.', cls='px-2', hx\_post=show\_host.rt(a='b'))))
print(cli.get('/autopost2').text)
\`\`\`

    <!doctype html>

    <html><body><div class="px-2" hx-post="/hostie?a=b">Text.</div>
    </body>
    </html>

\`\`\` python
@app.get
def autoget2(): return Html(Div('Text.', hx\_get=show\_host))
print(cli.get('/autoget2').text)
\`\`\`

    <!doctype html>

    <html><div hx-get="/hostie">Text.</div>
    </html>

\`\`\` python
@rt('/user/{nm}', name='gday')
def get(nm:str=''): return f"Good day to you, {nm}!"
cli.get('/user/Alexis').text
\`\`\`

    'Good day to you, Alexis!'

\`\`\` python
@app.get
def autolink(): return Html(Div('Text.', link=uri('gday', nm='Alexis')))
print(cli.get('/autolink').text)
\`\`\`

    <!doctype html>

    <html><div href="/user/Alexis">Text.</div>
    </html>

\`\`\` python
@rt('/link')
def get(req): return f"{req.url\_for('gday', nm='Alexis')}; {req.url\_for('show\_host')}"

cli.get('/link').text
\`\`\`

    'http://testserver/user/Alexis; http://testserver/hostie'

\`\`\` python
test\_eq(app.router.url\_path\_for('gday', nm='Jeremy'), '/user/Jeremy')
\`\`\`

\`\`\` python
hxhdr = {'headers':{'hx-request':"1"}}

@rt('/ft')
def get(): return Title('Foo'),H1('bar')

txt = cli.get('/ft').text
assert '<title>Foo</title>' in txt and '<h1>bar</h1>' in txt and '<html>' in txt

@rt('/xt2')
def get(): return H1('bar')

txt = cli.get('/xt2').text
assert '<title>FastHTML page</title>' in txt and '<h1>bar</h1>' in txt and '<html>' in txt

assert cli.get('/xt2', \*\*hxhdr).text.strip() == '<h1>bar</h1>'

@rt('/xt3')
def get(): return Html(Head(Title('hi')), Body(P('there')))

txt = cli.get('/xt3').text
assert '<title>FastHTML page</title>' not in txt and '<title>hi</title>' in txt and '<p>there</p>' in txt
\`\`\`

\`\`\` python
@rt('/oops')
def get(nope): return nope
test\_warns(lambda: cli.get('/oops?nope=1'))
\`\`\`

\`\`\` python
def test\_r(cli, path, exp, meth='get', hx=False, \*\*kwargs):
    if hx: kwargs\['headers'\] = {'hx-request':"1"}
    test\_eq(getattr(cli, meth)(path, \*\*kwargs).text, exp)

app.chk = 'foo'
ModelName = str\_enum('ModelName', "alexnet", "resnet", "lenet")
fake\_db = \[{"name": "Foo"}, {"name": "Bar"}\]
\`\`\`

\`\`\` python
@rt('/html/{idx}')
async def get(idx:int): return Body(H4(f'Next is {idx+1}.'))

reg\_re\_param("imgext", "ico|gif|jpg|jpeg|webm")

@rt(r'/static/{path:path}{fn}.{ext:imgext}')
def get(fn:str, path:str, ext:str): return f"Getting {fn}.{ext} from /{path}"

@rt("/models/{nm}")
def get(nm:ModelName): return nm

@rt("/files/{path}")
async def get(path: Path): return path.with\_suffix('.txt')

@rt("/items/")
def get(idx:int|None = 0): return fake\_db\[idx\]
\`\`\`

\`\`\` python
test\_r(cli, '/html/1', '<body><h4>Next is 2.</h4>\\n</body>\\n', hx=True)
test\_r(cli, '/static/foo/jph.ico', 'Getting jph.ico from /foo/')
test\_r(cli, '/models/alexnet', 'alexnet')
test\_r(cli, '/files/foo', 'foo.txt')
test\_r(cli, '/items/?idx=1', '{"name":"Bar"}')
test\_r(cli, '/items/', '{"name":"Foo"}')
assert cli.get('/items/?idx=g').text=='404 Not Found'
assert cli.get('/items/?idx=g').status\_code == 404
\`\`\`

\`\`\` python
@app.get("/booly/")
def \_(coming:bool=True): return 'Coming' if coming else 'Not coming'

@app.get("/datie/")
def \_(d:date): return d

@app.get("/ua")
async def \_(user\_agent:str): return user\_agent

@app.get("/hxtest")
def \_(htmx): return htmx.request

@app.get("/hxtest2")
def \_(foo:HtmxHeaders, req): return foo.request

@app.get("/app")
def \_(app): return app.chk

@app.get("/app2")
def \_(foo:FastHTML): return foo.chk,HttpHeader("mykey", "myval")
\`\`\`

\`\`\` python
test\_r(cli, '/booly/?coming=true', 'Coming')
test\_r(cli, '/booly/?coming=no', 'Not coming')
date\_str = "17th of May, 2024, 2p"
test\_r(cli, f'/datie/?d={date\_str}', '2024-05-17 14:00:00')
test\_r(cli, '/ua', 'FastHTML', headers={'User-Agent':'FastHTML'})
test\_r(cli, '/hxtest' , '1', headers={'HX-Request':'1'})
test\_r(cli, '/hxtest2', '1', headers={'HX-Request':'1'})
test\_r(cli, '/app' , 'foo')
\`\`\`

\`\`\` python
r = cli.get('/app2', \*\*hxhdr)
test\_eq(r.text, 'foo\\n')
test\_eq(r.headers\['mykey'\], 'myval')
\`\`\`

\`\`\` python
@rt
def meta(): 
    return ((Title('hi'),H1('hi')),
        (Meta(property='image'), Meta(property='site\_name'))
   )

t = cli.post('/meta').text
assert re.search(r'<body>\\s\*<h1>hi</h1>\\s\*</body>', t)
assert '<meta' in t
\`\`\`

\`\`\` python
@app.post('/profile/me')
def profile\_update(username: str): return username

test\_r(cli, '/profile/me', 'Alexis', 'post', data={'username' : 'Alexis'})
test\_r(cli, '/profile/me', 'Missing required field: username', 'post', data={})
\`\`\`

\`\`\` python
# Example post request with parameter that has a default value
@app.post('/pet/dog')
def pet\_dog(dogname: str = None): return dogname

# Working post request with optional parameter
test\_r(cli, '/pet/dog', '', 'post', data={})
\`\`\`

\`\`\` python
@dataclass
class Bodie: a:int;b:str

@rt("/bodie/{nm}")
def post(nm:str, data:Bodie):
    res = asdict(data)
    res\['nm'\] = nm
    return res

@app.post("/bodied/")
def bodied(data:dict): return data

nt = namedtuple('Bodient', \['a','b'\])

@app.post("/bodient/")
def bodient(data:nt): return asdict(data)

class BodieTD(TypedDict): a:int;b:str='foo'

@app.post("/bodietd/")
def bodient(data:BodieTD): return data

class Bodie2:
    a:int|None; b:str
    def \_\_init\_\_(self, a, b='foo'): store\_attr()

@app.post("/bodie2/")
def bodie(d:Bodie2): return f"a: {d.a}; b: {d.b}"
\`\`\`

\`\`\` python
from fasthtml.xtend import Titled
\`\`\`

\`\`\` python
# Testing POST with Content-Type: application/json
@app.post("/")
def index(it: Bodie): return Titled("It worked!", P(f"{it.a}, {it.b}"))

s = json.dumps({"b": "Lorem", "a": 15})
response = cli.post('/', headers={"Content-Type": "application/json"}, data=s).text
assert "<title>It worked!</title>" in response and "<p>15, Lorem</p>" in response
\`\`\`

\`\`\` python
# Testing POST with Content-Type: application/json
@app.post("/bodytext")
def index(body): return body

response = cli.post('/bodytext', headers={"Content-Type": "application/json"}, data=s).text
test\_eq(response, '{"b": "Lorem", "a": 15}')
\`\`\`

\`\`\` python
d = dict(a=1, b='foo')

test\_r(cli, '/bodie/me', '{"a":1,"b":"foo","nm":"me"}', 'post', data=dict(a=1, b='foo', nm='me'))
test\_r(cli, '/bodied/', '{"a":"1","b":"foo"}', 'post', data=d)
test\_r(cli, '/bodie2/', 'a: 1; b: foo', 'post', data={'a':1})
test\_r(cli, '/bodient/', '{"a":"1","b":"foo"}', 'post', data=d)
test\_r(cli, '/bodietd/', '{"a":1,"b":"foo"}', 'post', data=d)
\`\`\`

\`\`\` python
@rt("/setcookie")
def get(req): return cookie('now', datetime.now())

@rt("/getcookie")
def get(now:date): return f'Cookie was set at time {now.time()}'

print(cli.get('/setcookie').text)
time.sleep(0.01)
cli.get('/getcookie').text
\`\`\`

    'Cookie was set at time 19:10:33.000439'

\`\`\` python
@rt("/setsess")
def get(sess, foo:str=''):
    now = datetime.now()
    sess\['auth'\] = str(now)
    return f'Set to {now}'

@rt("/getsess")
def get(sess): return f'Session time: {sess\["auth"\]}'

print(cli.get('/setsess').text)
time.sleep(0.01)

cli.get('/getsess').text
\`\`\`

    Set to 2024-08-25 19:10:33.039493

    'Session time: 2024-08-25 19:10:33.039493'

\`\`\` python
@rt("/sess-first")
def post(sess, name: str):
    sess\["name"\] = name
    return str(sess)

cli.post('/sess-first', data={'name': 2})

@rt("/getsess-all")
def get(sess): return sess\['name'\]

test\_eq(cli.get('/getsess-all').text, '2')
\`\`\`

\`\`\` python
@rt("/upload")
async def post(uf:UploadFile): return (await uf.read()).decode()

with open('../../CHANGELOG.md', 'rb') as f:
    print(cli.post('/upload', files={'uf':f}, data={'msg':'Hello'}).text\[:15\])
\`\`\`

    # Release notes

\`\`\` python
@rt("/{fname:path}.{ext:static}")
async def get(fname:str, ext:str): return FileResponse(f'{fname}.{ext}')

assert 'These are the source notebooks for FastHTML' in cli.get('/README.txt').text
\`\`\`

\`\`\` python
@rt("/form-submit/{list\_id}")
def options(list\_id: str):
    headers = {
        'Access-Control-Allow-Origin': '\*',
        'Access-Control-Allow-Methods': 'POST',
        'Access-Control-Allow-Headers': '\*',
    }
    return Response(status\_code=200, headers=headers)
\`\`\`

\`\`\` python
h = cli.options('/form-submit/2').headers
test\_eq(h\['Access-Control-Allow-Methods'\], 'POST')
\`\`\`

\`\`\` python
from fasthtml.authmw import user\_pwd\_auth
\`\`\`

\`\`\` python
def \_not\_found(req, exc): return Div('nope')

app,cli,rt = get\_cli(FastHTML(exception\_handlers={404:\_not\_found}))

txt = cli.get('/').text
assert '<div>nope</div>' in txt
assert '<!doctype html>' in txt
\`\`\`

\`\`\` python
app,cli,rt = get\_cli(FastHTML())

@rt("/{name}/{age}")
def get(name: str, age: int): 
    return Titled(f"Hello {name.title()}, age {age}")

assert '<title>Hello Uma, age 5</title>' in cli.get('/uma/5').text
assert '404 Not Found' in cli.get('/uma/five').text
\`\`\`

\`\`\` python
auth = user\_pwd\_auth(testuser='spycraft')
app,cli,rt = get\_cli(FastHTML(middleware=\[auth\]))

@rt("/locked")
def get(auth): return 'Hello, ' + auth

test\_eq(cli.get('/locked').text, 'not authenticated')
test\_eq(cli.get('/locked', auth=("testuser","spycraft")).text, 'Hello, testuser')
\`\`\`

\`\`\` python
auth = user\_pwd\_auth(testuser='spycraft')
app,cli,rt = get\_cli(FastHTML(middleware=\[auth\]))

@rt("/locked")
def get(auth): return 'Hello, ' + auth

test\_eq(cli.get('/locked').text, 'not authenticated')
test\_eq(cli.get('/locked', auth=("testuser","spycraft")).text, 'Hello, testuser')
\`\`\`

\`\`\` python
from fasthtml.live\_reload import FastHTMLWithLiveReload
\`\`\`

\`\`\` python
hdrs, routes = app.router.hdrs, app.routes
app,cli,rt = get\_cli(FastHTMLWithLiveReload())

@rt("/hi")
def get(): return 'Hi there'

test\_eq(cli.get('/hi').text, "Hi there")

lr\_hdrs, lr\_routes = app.router.hdrs, app.routes
test\_eq(len(lr\_hdrs), len(hdrs)+1)
assert app.LIVE\_RELOAD\_HEADER in lr\_hdrs
test\_eq(len(lr\_routes), len(routes)+1)
assert app.LIVE\_RELOAD\_ROUTE in lr\_routes
\`\`\`
